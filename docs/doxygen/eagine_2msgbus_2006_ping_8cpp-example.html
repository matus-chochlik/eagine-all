<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta name="author" content="Matus Chochlik"/>
<meta name="copyright" content="Copyright 2015-2022 Matus Chochlik"/>
<meta name="keywords" content="C++ EGL OpenGL OpenAL Graphics Rendering"/>
<meta name="description" content="C++ wrapper for rendering C APIs"/>
<title>eagine/msgbus/006_ping.cpp</title>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="eagine.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="eagine-frame">
<div id="eagine-bar">
	<div id="eagine-top">
	<div id="eagine-top-content">
		<div id="eagine-caption">
	   		<div id="eagine-brief">
					<span id="eagine-name">EAGine&#160;</span>
					<span id="eagine-version">(0.87.0)</span> a C++ wrapper for rendering APIs
				</div>
		</div>
		<hr/>
	</div>
	</div>
	<div id="eagine-icon">
		<a href="http://oglplus.org/"><img src="../oglplus-circular.png"/></a>
	</div>
</div>
<div id="eagine-content">
<div id="top">
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">eagine/msgbus/006_ping.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>Copyright Matus Chochlik. Distributed under the Boost Software License, Version 1.0. See accompanying file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt">http://www.boost.org/LICENSE_1_0.txt</a></p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="valgrind_8hpp.html">eagine/interop/valgrind.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="eagine-core_2include_2eagine_2main_8hpp.html">eagine/main.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="actor_8hpp.html">eagine/msgbus/actor.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conn__setup_8hpp.html">eagine/msgbus/conn_setup.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="router__address_8hpp.html">eagine/msgbus/router_address.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timeout_8hpp.html">eagine/timeout.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="positive_8hpp.html">eagine/valid_if/positive.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceeagine.html">eagine</a> {</div>
<div class="line"><span class="keyword">namespace </span>msgbus {</div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="keyword">class </span>ping : <span class="keyword">public</span> actor&lt;2&gt; {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">using</span> base = actor&lt;2&gt;;</div>
<div class="line">    <span class="keyword">using</span> <a name="a0"></a><a class="code" href="classeagine_1_1msgbus_1_1actor.html#a2b0de7a7c12dfe2eda4682cad25d2302">base::bus_node</a>;</div>
<div class="line"> </div>
<div class="line">    ping(</div>
<div class="line">      <a name="a1"></a><a class="code" href="group__main__context.html#ga59362b2dde46bd0149d3c83950d879e9">main_ctx_parent</a> parent,</div>
<div class="line">      connection_setup&amp; conn_setup,</div>
<div class="line">      <span class="keyword">const</span> <a name="a2"></a><a class="code" href="group__string__utils.html#gae76dd3f0edeca37e438f5bbc2374e1b9">string_view</a> <a name="a3"></a><a class="code" href="group__memory.html#ga62558a22bf49982834d2fc9d56aa4a48">address</a>,</div>
<div class="line">      <span class="keyword">const</span> valid_if_positive&lt;std::size_t&gt;&amp; max)</div>
<div class="line">      : base(</div>
<div class="line">          {<a name="a4"></a><a class="code" href="group__identifiers.html#ga5811da4ab8e76916f5fad61d7c13d01f">EAGINE_ID</a>(ExamplPing), parent},</div>
<div class="line">          <span class="keyword">this</span>,</div>
<div class="line">          <a name="a5"></a><a class="code" href="group__msgbus.html#ga66a73fe549f3f7a726603167898fc2b7">EAGINE_MSG_MAP</a>(PingPong, Pong, ping, pong),</div>
<div class="line">          <a class="code" href="group__msgbus.html#ga66a73fe549f3f7a726603167898fc2b7">EAGINE_MSG_MAP</a>(PingPong, Ready, ping, ready))</div>
<div class="line">      , _lmod{<a name="a6"></a><a class="code" href="group__interop.html#gad7612655555a3ae896ab99409e8dc6f8">running_on_valgrind</a>() ? 1000U : 10000U}</div>
<div class="line">      , _max{extract_or(max, <a class="code" href="group__interop.html#gad7612655555a3ae896ab99409e8dc6f8">running_on_valgrind</a>() ? 10000U : 100000U)} {</div>
<div class="line">        this-&gt;allow_subscriptions();</div>
<div class="line"> </div>
<div class="line">        conn_setup.setup_connectors(</div>
<div class="line">          *<span class="keyword">this</span>,</div>
<div class="line">          <a name="a7"></a><a class="code" href="group__msgbus.html#gga3148ada31e187436f833d8d986ccfd53aaddc8b9ad12d25d13daeaee0a2bafc28">connection_kind::local_interprocess</a> |</div>
<div class="line">            <a name="a8"></a><a class="code" href="group__msgbus.html#gga3148ada31e187436f833d8d986ccfd53ab08d0957370e34275e9913a772e6d62b">connection_kind::remote_interprocess</a>,</div>
<div class="line">          <a class="code" href="group__memory.html#ga62558a22bf49982834d2fc9d56aa4a48">address</a>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> pong(<span class="keyword">const</span> message_context&amp;, <span class="keyword">const</span> stored_message&amp;) noexcept -&gt; <span class="keywordtype">bool</span> {</div>
<div class="line">        <span class="keywordflow">if</span>(++_rcvd % _lmod == 0) {</div>
<div class="line">            <a class="code" href="classeagine_1_1msgbus_1_1actor.html#a2b0de7a7c12dfe2eda4682cad25d2302">bus_node</a>()</div>
<div class="line">              .log_info(<span class="stringliteral">&quot;received ${count} pongs&quot;</span>)</div>
<div class="line">              .arg(<a class="code" href="group__identifiers.html#ga5811da4ab8e76916f5fad61d7c13d01f">EAGINE_ID</a>(count), _rcvd);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span>(_rcvd &lt; _max) {</div>
<div class="line">            _timeout.reset();</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> ready(<span class="keyword">const</span> message_context&amp;, <span class="keyword">const</span> stored_message&amp;) noexcept -&gt; <span class="keywordtype">bool</span> {</div>
<div class="line">        _ready = <span class="keyword">true</span>;</div>
<div class="line">        <a class="code" href="classeagine_1_1msgbus_1_1actor.html#a2b0de7a7c12dfe2eda4682cad25d2302">bus_node</a>().log_info(<span class="stringliteral">&quot;received pong ready message&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> shutdown() noexcept {</div>
<div class="line">        <a class="code" href="classeagine_1_1msgbus_1_1actor.html#a2b0de7a7c12dfe2eda4682cad25d2302">bus_node</a>().broadcast(<a name="a9"></a><a class="code" href="group__identifiers.html#ga83fbdca8622b345d98917a7bea5504b2">EAGINE_MSG_ID</a>(PingPong, Shutdown));</div>
<div class="line">        <a class="code" href="classeagine_1_1msgbus_1_1actor.html#a2b0de7a7c12dfe2eda4682cad25d2302">bus_node</a>().log_info(<span class="stringliteral">&quot;sent shutdown message&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> update() noexcept {</div>
<div class="line">        <span class="keywordflow">if</span>(_ready &amp;&amp; (_sent &lt;= _max * 2) &amp;&amp; (_sent &lt; _rcvd + _lmod)) {</div>
<div class="line">            <a class="code" href="classeagine_1_1msgbus_1_1actor.html#a2b0de7a7c12dfe2eda4682cad25d2302">bus_node</a>().broadcast(<a class="code" href="group__identifiers.html#ga83fbdca8622b345d98917a7bea5504b2">EAGINE_MSG_ID</a>(PingPong, Ping));</div>
<div class="line">            <span class="keywordflow">if</span>(++_sent % _lmod == 0) {</div>
<div class="line">                <a class="code" href="classeagine_1_1msgbus_1_1actor.html#a2b0de7a7c12dfe2eda4682cad25d2302">bus_node</a>()</div>
<div class="line">                  .log_info(<span class="stringliteral">&quot;sent ${count} pings&quot;</span>)</div>
<div class="line">                  .arg(<a class="code" href="group__identifiers.html#ga5811da4ab8e76916f5fad61d7c13d01f">EAGINE_ID</a>(count), _sent);</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            std::this_thread::yield();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> is_done() <span class="keyword">const</span> noexcept -&gt; <span class="keywordtype">bool</span> {</div>
<div class="line">        <span class="keywordflow">return</span> (_rcvd &gt;= _max) || _timeout;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> pings_per_second(<span class="keyword">const</span> std::chrono::duration&lt;float&gt; s) <span class="keyword">const</span> noexcept {</div>
<div class="line">        <span class="keywordflow">return</span> float(_rcvd) / s.count();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    std::size_t _lmod{1};</div>
<div class="line">    std::size_t _sent{0};</div>
<div class="line">    std::size_t _rcvd{0};</div>
<div class="line">    <span class="keyword">const</span> std::size_t _max{1000000};</div>
<div class="line">    timeout _timeout{std::chrono::seconds(30)};</div>
<div class="line">    <span class="keywordtype">bool</span> _ready{<span class="keyword">false</span>};</div>
<div class="line">};</div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line">} <span class="comment">// namespace msgbus</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> main(main_ctx&amp; ctx) -&gt; <span class="keywordtype">int</span> {</div>
<div class="line">    msgbus::router_address <a class="code" href="group__memory.html#ga62558a22bf49982834d2fc9d56aa4a48">address</a>{ctx};</div>
<div class="line">    msgbus::connection_setup conn_setup(ctx);</div>
<div class="line"> </div>
<div class="line">    valid_if_positive&lt;std::size_t&gt; ping_count{};</div>
<div class="line">    <span class="keywordflow">if</span>(<span class="keyword">auto</span> arg{ctx.args().<a name="a10"></a><a class="code" href="group__memory.html#ga06ef9a335a56af00cc7fb890bb096b3d">find</a>(<span class="stringliteral">&quot;--ping-count&quot;</span>)}) {</div>
<div class="line">        arg.next().parse(ping_count, ctx.log().error_stream());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    msgbus::ping ping(ctx, conn_setup, <a class="code" href="group__memory.html#ga62558a22bf49982834d2fc9d56aa4a48">address</a>, ping_count);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> time_measure run_time;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(!ping.is_done()) {</div>
<div class="line">        ping.update();</div>
<div class="line">        ping.process_all();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> elapsed = run_time.seconds();</div>
<div class="line"> </div>
<div class="line">    ctx.log()</div>
<div class="line">      .info(<span class="stringliteral">&quot;execution time ${time}, ${pps} pings per second&quot;</span>)</div>
<div class="line">      .arg(<a class="code" href="group__identifiers.html#ga5811da4ab8e76916f5fad61d7c13d01f">EAGINE_ID</a>(time), elapsed)</div>
<div class="line">      .arg(<a class="code" href="group__identifiers.html#ga5811da4ab8e76916f5fad61d7c13d01f">EAGINE_ID</a>(pps), ping.pings_per_second(elapsed));</div>
<div class="line"> </div>
<div class="line">    ping.shutdown();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line">} <span class="comment">// namespace eagine</span></div>
<div class="ttc" id="aactor_8hpp_html"><div class="ttname"><a href="actor_8hpp.html">actor.hpp</a></div></div>
<div class="ttc" id="aclasseagine_1_1msgbus_1_1actor_html_a2b0de7a7c12dfe2eda4682cad25d2302"><div class="ttname"><a href="classeagine_1_1msgbus_1_1actor.html#a2b0de7a7c12dfe2eda4682cad25d2302">eagine::msgbus::actor&lt; 2 &gt;::bus_node</a></div><div class="ttdeci">auto bus_node() noexcept -&gt; endpoint &amp;</div><div class="ttdoc">Returns a reference to the associated endpoint.</div><div class="ttdef"><b>Definition:</b> actor.hpp:45</div></div>
<div class="ttc" id="aconn__setup_8hpp_html"><div class="ttname"><a href="conn__setup_8hpp.html">conn_setup.hpp</a></div></div>
<div class="ttc" id="aeagine-core_2include_2eagine_2main_8hpp_html"><div class="ttname"><a href="eagine-core_2include_2eagine_2main_8hpp.html">main.hpp</a></div></div>
<div class="ttc" id="agroup__identifiers_html_ga5811da4ab8e76916f5fad61d7c13d01f"><div class="ttname"><a href="group__identifiers.html#ga5811da4ab8e76916f5fad61d7c13d01f">EAGINE_ID</a></div><div class="ttdeci">#define EAGINE_ID(NAME)</div><div class="ttdoc">Macro for constructing instances of eagine::identifier.</div><div class="ttdef"><b>Definition:</b> identifier.hpp:368</div></div>
<div class="ttc" id="agroup__identifiers_html_ga83fbdca8622b345d98917a7bea5504b2"><div class="ttname"><a href="group__identifiers.html#ga83fbdca8622b345d98917a7bea5504b2">EAGINE_MSG_ID</a></div><div class="ttdeci">#define EAGINE_MSG_ID(API, NAME)</div><div class="ttdoc">Macro for instantiating objects of static_message_id.</div><div class="ttdef"><b>Definition:</b> message_id.hpp:148</div></div>
<div class="ttc" id="agroup__interop_html_gad7612655555a3ae896ab99409e8dc6f8"><div class="ttname"><a href="group__interop.html#gad7612655555a3ae896ab99409e8dc6f8">eagine::running_on_valgrind</a></div><div class="ttdeci">static constexpr auto running_on_valgrind() noexcept -&gt; tribool</div><div class="ttdoc">Indicates if the current process runs on top of valgrind.</div><div class="ttdef"><b>Definition:</b> valgrind.hpp:30</div></div>
<div class="ttc" id="agroup__main__context_html_ga59362b2dde46bd0149d3c83950d879e9"><div class="ttname"><a href="group__main__context.html#ga59362b2dde46bd0149d3c83950d879e9">eagine::main_ctx_parent</a></div><div class="ttdeci">const main_ctx_object_parent_info &amp; main_ctx_parent</div><div class="ttdoc">Alias for main_ctx_object_parent_info parameter type.</div><div class="ttdef"><b>Definition:</b> main_ctx_fwd.hpp:47</div></div>
<div class="ttc" id="agroup__memory_html_ga06ef9a335a56af00cc7fb890bb096b3d"><div class="ttname"><a href="group__memory.html#ga06ef9a335a56af00cc7fb890bb096b3d">eagine::memory::find</a></div><div class="ttdeci">static auto find(const basic_span&lt; T1, P1, S1 &gt; where, const basic_span&lt; T2, P2, S2 &gt; what) -&gt; basic_span&lt; T1, P1, S1 &gt;</div><div class="ttdoc">Finds the position of the last occurrence of what in a span.</div><div class="ttdef"><b>Definition:</b> span_algo.hpp:398</div></div>
<div class="ttc" id="agroup__memory_html_ga62558a22bf49982834d2fc9d56aa4a48"><div class="ttname"><a href="group__memory.html#ga62558a22bf49982834d2fc9d56aa4a48">eagine::memory::address</a></div><div class="ttdeci">basic_address&lt; false &gt; address</div><div class="ttdoc">Type alias for non-const memory address values.</div><div class="ttdef"><b>Definition:</b> address.hpp:217</div></div>
<div class="ttc" id="agroup__msgbus_html_ga66a73fe549f3f7a726603167898fc2b7"><div class="ttname"><a href="group__msgbus.html#ga66a73fe549f3f7a726603167898fc2b7">EAGINE_MSG_MAP</a></div><div class="ttdeci">#define EAGINE_MSG_MAP(CLASS_ID, METHOD_ID, CLASS, METHOD)</div><div class="ttdoc">Constructs an instance of static message handler map.</div><div class="ttdef"><b>Definition:</b> handler_map.hpp:72</div></div>
<div class="ttc" id="agroup__msgbus_html_gga3148ada31e187436f833d8d986ccfd53aaddc8b9ad12d25d13daeaee0a2bafc28"><div class="ttname"><a href="group__msgbus.html#gga3148ada31e187436f833d8d986ccfd53aaddc8b9ad12d25d13daeaee0a2bafc28">eagine::msgbus::connection_kind::local_interprocess</a></div><div class="ttdeci">@ local_interprocess</div><div class="ttdoc">Inter-process connection for local communication.</div></div>
<div class="ttc" id="agroup__msgbus_html_gga3148ada31e187436f833d8d986ccfd53ab08d0957370e34275e9913a772e6d62b"><div class="ttname"><a href="group__msgbus.html#gga3148ada31e187436f833d8d986ccfd53ab08d0957370e34275e9913a772e6d62b">eagine::msgbus::connection_kind::remote_interprocess</a></div><div class="ttdeci">@ remote_interprocess</div><div class="ttdoc">Inter-process connection for remote communucation.</div></div>
<div class="ttc" id="agroup__string__utils_html_gae76dd3f0edeca37e438f5bbc2374e1b9"><div class="ttname"><a href="group__string__utils.html#gae76dd3f0edeca37e438f5bbc2374e1b9">eagine::string_view</a></div><div class="ttdeci">basic_string_span&lt; const char &gt; string_view</div><div class="ttdoc">Alias for const string views.</div><div class="ttdef"><b>Definition:</b> string_span.hpp:140</div></div>
<div class="ttc" id="anamespaceeagine_html"><div class="ttname"><a href="namespaceeagine.html">eagine</a></div><div class="ttdoc">Common code is placed in this namespace.</div><div class="ttdef"><b>Definition:</b> app_config.inl:25</div></div>
<div class="ttc" id="apositive_8hpp_html"><div class="ttname"><a href="positive_8hpp.html">positive.hpp</a></div></div>
<div class="ttc" id="arouter__address_8hpp_html"><div class="ttname"><a href="router__address_8hpp.html">router_address.hpp</a></div></div>
<div class="ttc" id="atimeout_8hpp_html"><div class="ttname"><a href="timeout_8hpp.html">timeout.hpp</a></div></div>
<div class="ttc" id="avalgrind_8hpp_html"><div class="ttname"><a href="valgrind_8hpp.html">valgrind.hpp</a></div></div>
</div><!-- fragment --> </div><!-- contents -->
<br/>
<div id="eagine-bottom">
<em>Copyright &copy; 2015-2022</em> <strong>Matúš Chochlík</strong>.<br/>
&lt;<a href="mailto:chochlik@gmail.com">chochlik -at -gmail.com</a>&gt;<br/>
Documentation generated on Wed May 18 2022 by <a href="http://www.doxygen.org/index.html">Doxygen</a> (version 1.9.1).
</div> <!-- eagine-bottom -->
</div> <!-- eagine-content -->
</div> <!-- eagine-frame -->
</body>
</html>
